name: â˜ï¸ Nuitka äº‘ç«¯æ‰“åŒ…å·¥å…· (v7.0)

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'ğŸ“„ Python å…¥å£è„šæœ¬æ–‡ä»¶å'
        required: true
        default: 'main.py'
        type: string
      
      build_mode:
        description: 'ğŸ“¦ æ‰“åŒ…æ¨¡å¼'
        required: true
        default: 'standalone'
        type: choice
        options:
          - standalone
          - onefile
      
      icon_file:
        description: 'ğŸ¨ å›¾æ ‡æ–‡ä»¶å (ç•™ç©ºåˆ™ä¸ä½¿ç”¨å›¾æ ‡)'
        required: false
        default: 'exe.ico'
        type: string
      
      requirements_file:
        description: 'ğŸ“‹ ä¾èµ–æ–‡ä»¶å'
        required: false
        default: 'requirements.txt'
        type: string
      
      python_version:
        description: 'ğŸ Python ç‰ˆæœ¬'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
      
      enable_console:
        description: 'ğŸ–¥ï¸ å¯ç”¨æ§åˆ¶å°çª—å£'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      
      enable_pyside6:
        description: 'ğŸ¯ å¯ç”¨ PySide6 æ’ä»¶'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      extra_include_packages:
        description: 'ğŸ“š é¢å¤–åŒ…å«çš„åŒ… (é€—å·åˆ†éš”)'
        required: false
        default: ''
        type: string
      
      product_name:
        description: 'ğŸ“ äº§å“åç§°'
        required: false
        default: 'MyApp'
        type: string
      
      product_version:
        description: 'ğŸ·ï¸ äº§å“ç‰ˆæœ¬'
        required: false
        default: '1.0.0.0'
        type: string
      
      company_name:
        description: 'ğŸ¢ å…¬å¸åç§°'
        required: false
        default: 'MyCompany'
        type: string

jobs:
  build:
    name: ğŸš€ Build on Windows
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“¥ Check-out repository
        uses: actions/checkout@v4

      - name: ğŸ’¾ Configure Pagefile
        uses: al-cheb/configure-pagefile-action@v1.4
        with:
          minimum-size: 8GB
          maximum-size: 16GB
          disk-root: "C:"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          architecture: 'x64'

      - name: ğŸ” Validate Input Files
        id: validate
        shell: pwsh
        run: |
          $hasError = $false
          
          $scriptFile = "${{ inputs.script_name }}"
          if (Test-Path $scriptFile) {
            Write-Host "âœ… å…¥å£è„šæœ¬: $scriptFile" -ForegroundColor Green
          } else {
            Write-Host "âŒ å…¥å£è„šæœ¬ä¸å­˜åœ¨: $scriptFile" -ForegroundColor Red
            Get-ChildItem -Filter "*.py" | ForEach-Object { Write-Host "   å¯ç”¨: $($_.Name)" }
            $hasError = $true
          }
          
          $reqFile = "${{ inputs.requirements_file }}"
          if (Test-Path $reqFile) {
            Write-Host "âœ… ä¾èµ–æ–‡ä»¶: $reqFile" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸ ä¾èµ–æ–‡ä»¶ä¸å­˜åœ¨: $reqFile" -ForegroundColor Yellow
          }
          
          $iconFile = "${{ inputs.icon_file }}"
          $iconExists = "false"
          if ($iconFile -and $iconFile -ne "" -and (Test-Path $iconFile)) {
            Write-Host "âœ… å›¾æ ‡æ–‡ä»¶: $iconFile" -ForegroundColor Green
            $iconExists = "true"
          } elseif ($iconFile -and $iconFile -ne "") {
            Write-Host "âš ï¸ å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $iconFile" -ForegroundColor Yellow
          }
          echo "icon_exists=$iconExists" >> $env:GITHUB_OUTPUT
          
          if ($hasError) { exit 1 }

      - name: ğŸ“¦ Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install nuitka zstandard ordered-set
          
          $reqFile = "${{ inputs.requirements_file }}"
          if (Test-Path $reqFile) {
            Write-Host ">>> å®‰è£… $reqFile ä¸­çš„æ‰€æœ‰ä¾èµ–" -ForegroundColor Yellow
            python -m pip install -r $reqFile
          }
          
          Write-Host "`nâœ… ä¾èµ–å®‰è£…å®Œæˆ" -ForegroundColor Green
          python -m pip list

      - name: ğŸ”¬ Verify Modules
        shell: pwsh
        run: |
          python -c "import rembg; print('âœ… rembg:', rembg.__file__)" 2>&1
          python -c "import onnxruntime; print('âœ… onnxruntime:', onnxruntime.__file__)" 2>&1
          python -c "import PySide6; print('âœ… PySide6:', PySide6.__file__)" 2>&1

      - name: ğŸ”§ Generate Nuitka Parameters
        id: nuitka_params
        shell: pwsh
        run: |
          $reqFile = "${{ inputs.requirements_file }}"
          $packages = @()
          $packageData = @()
          
          if (Test-Path $reqFile) {
            $content = Get-Content $reqFile
            foreach ($line in $content) {
              $line = $line.Trim()
              if ([string]::IsNullOrEmpty($line) -or $line.StartsWith("#")) { continue }
              
              $pkgName = $line -replace '[<>=!].*$', '' -replace '\[.*\]', ''
              $pkgName = $pkgName.Trim().ToLower()
              
              $importName = switch ($pkgName) {
                "pillow" { "PIL" }
                "opencv-python" { "cv2" }
                "opencv-python-headless" { "cv2" }
                "scikit-image" { "skimage" }
                "pyside6" { "PySide6" }
                "pyside6_addons" { $null }
                "pyside6_essentials" { $null }
                default { $pkgName -replace '-', '_' }
              }
              
              if ($importName) {
                $packages += $importName
                if ($importName -in @("rembg", "onnxruntime", "pooch", "PySide6")) {
                  $packageData += $importName
                }
              }
            }
          }
          
          $extraPkgs = "${{ inputs.extra_include_packages }}"
          if ($extraPkgs) {
            $extraPkgs.Split(',') | ForEach-Object {
              $pkg = $_.Trim()
              if ($pkg -and $pkg -notin $packages) {
                $packages += $pkg
                $packageData += $pkg
              }
            }
          }
          
          $packagesStr = $packages -join "`n"
          $packageDataStr = $packageData -join "`n"
          
          Write-Host "Include packages:" -ForegroundColor Cyan
          Write-Host $packagesStr
          Write-Host "`nInclude package data:" -ForegroundColor Cyan
          Write-Host $packageDataStr
          
          echo "INCLUDE_PACKAGES<<EOF" >> $env:GITHUB_ENV
          echo $packagesStr >> $env:GITHUB_ENV
          echo "EOF" >> $env:GITHUB_ENV
          
          echo "INCLUDE_PACKAGE_DATA<<EOF" >> $env:GITHUB_ENV
          echo $packageDataStr >> $env:GITHUB_ENV
          echo "EOF" >> $env:GITHUB_ENV

      - name: ğŸ“ Prepare Assets
        shell: pwsh
        run: |
          if (-not (Test-Path "assets")) {
            New-Item -ItemType Directory -Path "assets" -Force | Out-Null
          }
          $iconFile = "${{ inputs.icon_file }}"
          if ($iconFile -and (Test-Path $iconFile)) {
            Copy-Item $iconFile -Destination "assets/" -Force
          }

      - name: ğŸ”¨ Build with Nuitka (with icon)
        if: steps.validate.outputs.icon_exists == 'true'
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          include-package: ${{ env.INCLUDE_PACKAGES }}
          include-package-data: ${{ env.INCLUDE_PACKAGE_DATA }}
          nofollow-import-to: |
            pytest
            setuptools
            distutils
            unittest
            test
            tests
          enable-plugins: ${{ inputs.enable_pyside6 == 'true' && 'pyside6' || '' }}
          noinclude-pytest-mode: nofollow
          noinclude-setuptools-mode: nofollow
          noinclude-unittest-mode: nofollow
          windows-icon-from-ico: ${{ inputs.icon_file }}
          windows-console-mode: ${{ inputs.enable_console == 'true' && 'force' || 'disable' }}
          output-dir: build
          assume-yes-for-downloads: true
          company-name: ${{ inputs.company_name }}
          product-name: ${{ inputs.product_name }}
          file-version: ${{ inputs.product_version }}
          product-version: ${{ inputs.product_version }}
          file-description: ${{ inputs.product_name }}

      - name: ğŸ”¨ Build with Nuitka (without icon)
        if: steps.validate.outputs.icon_exists != 'true'
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ${{ inputs.script_name }}
          mode: ${{ inputs.build_mode }}
          include-package: ${{ env.INCLUDE_PACKAGES }}
          include-package-data: ${{ env.INCLUDE_PACKAGE_DATA }}
          nofollow-import-to: |
            pytest
            setuptools
            distutils
            unittest
            test
            tests
          enable-plugins: ${{ inputs.enable_pyside6 == 'true' && 'pyside6' || '' }}
          noinclude-pytest-mode: nofollow
          noinclude-setuptools-mode: nofollow
          noinclude-unittest-mode: nofollow
          windows-console-mode: ${{ inputs.enable_console == 'true' && 'force' || 'disable' }}
          output-dir: build
          assume-yes-for-downloads: true
          company-name: ${{ inputs.company_name }}
          product-name: ${{ inputs.product_name }}
          file-version: ${{ inputs.product_version }}
          product-version: ${{ inputs.product_version }}
          file-description: ${{ inputs.product_name }}

      - name: ğŸ“‹ Verify Build Output
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "         éªŒè¯æ„å»ºè¾“å‡º" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          if (Test-Path "build") {
            Get-ChildItem -Path "build" -Recurse -Depth 2 | ForEach-Object {
              Write-Host $_.FullName
            }
            
            $distDirs = Get-ChildItem -Path "build" -Filter "*.dist" -Directory
            foreach ($dist in $distDirs) {
              Write-Host "`næ£€æŸ¥ $($dist.Name):" -ForegroundColor Cyan
              
              $rembgPath = Join-Path $dist.FullName "rembg"
              if (Test-Path $rembgPath) {
                Write-Host "âœ… rembg å·²æ‰“åŒ…" -ForegroundColor Green
              } else {
                Write-Host "âŒ rembg æœªæ‰“åŒ…" -ForegroundColor Red
              }
              
              $onnxPath = Join-Path $dist.FullName "onnxruntime"
              if (Test-Path $onnxPath) {
                Write-Host "âœ… onnxruntime å·²æ‰“åŒ…" -ForegroundColor Green
              } else {
                Write-Host "âŒ onnxruntime æœªæ‰“åŒ…" -ForegroundColor Red
              }
            }
          } else {
            Write-Host "âŒ build ç›®å½•ä¸å­˜åœ¨" -ForegroundColor Red
          }

      - name: ğŸ“¤ Upload Artifact (standalone)
        if: inputs.build_mode == 'standalone'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-${{ inputs.product_version }}-standalone
          path: build/*.dist/
          include-hidden-files: true
          retention-days: 30

      - name: ğŸ“¤ Upload Artifact (onefile)
        if: inputs.build_mode == 'onefile'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.product_name }}-${{ inputs.product_version }}-onefile
          path: build/*.exe
          retention-days: 30

      - name: ğŸ“Š Build Summary
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "         æ„å»ºå®Œæˆ!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "äº§å“åç§°: ${{ inputs.product_name }}" -ForegroundColor Cyan
          Write-Host "ç‰ˆæœ¬: ${{ inputs.product_version }}" -ForegroundColor Cyan
          Write-Host "æ‰“åŒ…æ¨¡å¼: ${{ inputs.build_mode }}" -ForegroundColor Cyan
          Write-Host "Python ç‰ˆæœ¬: ${{ inputs.python_version }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "è¯·åœ¨ Actions é¡µé¢ä¸‹è½½æ„å»ºäº§ç‰©" -ForegroundColor Yellow
